<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Audit Launcher ©MTY Finglas</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

<style>
    /* ================= UI STYLES ================= */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0; padding: 0; background: #f4f6f8; font-size: 14px; color: #333;
        padding-bottom: 120px; overscroll-behavior-y: none;
    }

    /* === LAUNCHER SCREEN === */
    #launcher {
        position: fixed; inset: 0; background: #2c3e50; z-index: 20000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px;
    }
    .launcher-card {
        background: white; width: 100%; max-width: 400px; padding: 30px;
        border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center;
    }
    .launcher-title { font-size: 22px; font-weight: 800; color: #2c3e50; margin-bottom: 25px; text-transform: uppercase; }
    .btn-launch {
        display: block; width: 100%; padding: 15px; margin-bottom: 15px;
        border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer;
        transition: transform 0.1s;
    }
    .btn-launch:active { transform: scale(0.98); }
    .btn-did { background: #3498db; color: white; }
    .btn-mty { background: #27ae60; color: white; }

    /* === MAIN APP (Hidden by default) === */
    #main-app-wrapper { display: none; }

    .app-header {
        background: #2c3e50; color: white; padding: 12px 16px;
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .app-title { font-size: 16px; font-weight: 700; text-transform: uppercase; }
    .header-actions { display: flex; gap: 10px; }
    .btn-header { border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; color: white; text-transform: uppercase; }
    .btn-dl { background: #3498db; } .btn-reset { background: #e74c3c; }

    #app-container { width: 100%; max-width: 800px; margin: 0 auto; }
    .audit-section { display: none; }
    .audit-section.active { display: block; }

    .sheet { background: #fff; margin: 15px; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; min-height: 80vh; }
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 10px; }
    h1 { font-size: 18px; margin: 0; color: #2c3e50; font-weight: 800; }
    .date-time { font-size: 11px; color: #95a5a6; font-weight: 600; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    th { text-align: left; font-size: 10px; color: #95a5a6; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    td { padding: 12px 2px; border-bottom: 1px solid #f5f6fa; vertical-align: top; }
    
    .col-cat { display: none; } 
    .col-item { width: 50%; font-size: 13px; font-weight: 500; line-height: 1.3; color: #2c3e50; }
    .col-check { width: 15%; text-align: center; }
    .col-action { width: 35%; }

    .choice { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #ecf0f1; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: #fff; }
    .choice.yes.active { background: #2ecc71; border-color: #2ecc71; }
    .choice.yes.active::after { content: "✔"; color: white; font-size: 22px; }
    .choice.no.active { background: #e74c3c; border-color: #e74c3c; }
    .choice.no.active::after { content: "✖"; color: white; font-size: 22px; }

    textarea { width: 100%; height: 40px; border: 1px solid #dfe6e9; border-radius: 6px; padding: 8px; font-size: 13px; resize: none; font-family: inherit; }
    .notes-container { margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; flex-grow: 1; margin-bottom: 90px; }
    .notes-box { height: 100px; width: 100%; border: 1px solid #dfe6e9; background: #fff; padding: 8px; white-space: pre-wrap; overflow-y: auto; }
    
    .pdf-text-mirror { display: none; }

    .signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .sig-line { border-bottom: 2px solid #bdc3c7; height: 35px; margin-bottom: 4px; }
    .sig-text { font-size: 10px; color: #95a5a6; text-transform: uppercase; font-weight: 700; }

    .photo-sheet { display: none; flex-direction: column; background: #fff; }
    .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
    .photo-card { background: #fff; padding: 4px; border: 1px solid #ecf0f1; border-radius: 6px; text-align: center; }
    .photo-card img { width: 100%; height: auto; border-radius: 4px; }

    .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 12px 20px; display: flex; justify-content: space-between; gap: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 99; }
    .btn { padding: 14px 20px; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; flex: 1; }
    .btn-prev { background: #ecf0f1; color: #7f8c8d; flex: 0 0 80px; }
    .btn-next { background: #3498db; color: white; }
    .btn-submit { background: #27ae60; color: white; display: none; width: 100%; }

    #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; }

    /* ================= PDF MODE ================= */
    .pdf-mode { width: 195mm !important; margin: 0 auto !important; padding: 0 !important; background: white !important; }
    .pdf-mode .audit-section { display: block !important; }
    .pdf-mode .sheet { width: 100% !important; height: 288mm !important; margin: 0 !important; padding: 10mm !important; box-shadow: none !important; border: 1px solid #333 !important; border-radius: 0 !important; page-break-after: always; overflow: hidden; display: block !important; position: relative; }
    .pdf-mode h1 { font-size: 22px !important; margin-bottom: 5px; }
    .pdf-mode .date-time { font-size: 12px !important; }
    .pdf-mode table { margin-bottom: 10px; border: 1px solid #000; table-layout: fixed; }
    .pdf-mode th { padding: 8px 6px !important; font-size: 11px; border: 1px solid #000; background: #e0e0e0; color: #000; font-weight: 900; }
    .pdf-mode td { padding: 8px 6px !important; border: 1px solid #000; vertical-align: middle; font-size: 12px !important; line-height: 1.4; height: auto !important; word-wrap: break-word; }
    .pdf-mode .col-cat { display: table-cell !important; width: 12%; font-weight: 900; text-align: center; font-size: 10px; background: #f2f2f2; }
    .pdf-mode .col-item { width: 45%; }
    .pdf-mode .col-check { width: 8%; text-align: center; }
    .pdf-mode .col-action { width: 35%; }
    .pdf-mode textarea { display: none !important; }
    .pdf-mode .pdf-text-mirror { display: block !important; white-space: pre-wrap !important; font-size: 12px; color: #000; line-height: 1.3; }
    .pdf-mode .choice { width: 100%; height: 16px; border: none; background: transparent !important; } 
    .pdf-mode .choice.yes.active::after { content: "YES"; font-size: 12px; font-weight: 900; color: #000; }
    .pdf-mode .choice.no.active::after { content: "NO"; font-size: 12px; font-weight: 900; color: #000; }
    .pdf-mode .notes-container { margin-top: 10px; padding: 0; background: transparent; border: none; }
    .pdf-mode .notes-box { height: auto !important; min-height: 150px; border: 1px solid #000 !important; padding: 8px; margin-bottom: 0; }
    .pdf-mode .signatures { position: absolute; bottom: 10mm; left: 10mm; right: 10mm; margin: 0; border-top: 1px dashed #000; padding-top: 10px; }
    .pdf-mode .sig-line { height: 30px; border-bottom: 1px solid #000; }
    .pdf-mode .sig-text { font-size: 11px !important; }
    .pdf-mode .photo-sheet { display: flex !important; border: none !important; page-break-after: always; height: 288mm !important; padding: 10mm !important; }
    .pdf-mode .photo-grid { display: grid !important; height: 100%; width: 100%; align-content: start; }
    .pdf-mode .photo-grid .photo-card img { max-height: 200px; object-fit: contain; }
    .pdf-mode .photo-grid.p-1 { display: flex !important; align-items: center; justify-content: center; height: 100%; }
    .pdf-mode .photo-grid.p-1 .photo-card { width: 100%; border: none; }
    .pdf-mode .photo-grid.p-1 img { max-height: 160mm; width: auto; max-width: 100%; }
    .pdf-mode .photo-grid.p-2 { display: flex !important; flex-direction: column; justify-content: space-around; height: 100%; }
    .pdf-mode .photo-grid.p-2 .photo-card { width: 100%; border: none; }
    .pdf-mode .photo-grid.p-2 img { max-height: 110mm; width: auto; max-width: 100%; }
    .pdf-mode .app-header, .pdf-mode .nav-bar { display: none !important; }
</style>
</head>

<body>

<div id="launcher">
    <div class="launcher-card">
        <div class="launcher-title">Select Audit Type</div>
        <button class="btn-launch btn-did" onclick="selectMode('did')">DID Standard</button>
        <button class="btn-launch btn-mty" onclick="selectMode('mty')">MTY Core Compliance</button>
    </div>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">

<div id="loadingOverlay" style="display:none;"><div id="loadingText">BOOTING AUDIT ENGINE...</div></div>

<div id="main-app-wrapper">
    <div class="app-header">
        <div class="app-title" id="pageTitle">AUDIT V13</div>
        <div class="header-actions">
            <button class="btn-header btn-reset" onclick="resetForm()">Reset</button>
        </div>
    </div>

    <div id="app-container">
        </div>

    <div class="nav-bar">
        <button class="btn btn-prev" onclick="changeSection(-1)">Back</button>
        <button class="btn btn-next" onclick="changeSection(1)">Next</button>
        <button class="btn btn-submit" id="shareBtn" onclick="handleEmailAction()">Submit & Share</button>
    </div>
</div>

<script>
    // ==========================================
    // 1. DATA DEFINITIONS
    // ==========================================

    const DATA_DID = [
        { id: 0, title: "Smalls Guideline", rows: [
            ["PRICE", "Price ticket cut straight"], ["PRICE", "Price ticket right of product"], ["PRICE", "No broken holders"], ["PRICE", "Tickets on edge of shelf"], ["PRICE", "Gun labels top right"],
            ["MERCH", "Promo in ticket holder"], ["MERCH", "Promo in correct position"], ["MERCH", "Supplier stickers removed"], ["MERCH", "Smalls in price order"], ["MERCH", "Stock to height & front"], ["MERCH", "Boxed stock lined up"], ["MERCH", "End caps dual displayed"], ["MERCH", "Essentials in place/priced"],
            ["HOUSE", "Product clean (no dust)"], ["HOUSE", "Shelves free of dust/gum"], ["HOUSE", "Barcodes hidden"], ["HOUSE", "Box product free from dust"], ["HOUSE", "Floor area vacuumed"]
        ]},
        { id: 1, title: "TV & Audio Audit", rows: [
            ["PRICE", "Price ticket cut straight"], ["PRICE", "Ticket in correct position"], ["PRICE", "No broken holders"], ["PRICE", "Tickets on edge of shelving"], ["PRICE", "Energy Label Correct Pos"], ["PRICE", "Energy Label Correct Size"],
            ["MERCH", "All stickers removed"], ["MERCH", "Essentials in place/priced"], ["MERCH", "Product Price/Size Logic"], ["MERCH", "Product fully cleaned"], ["MERCH", "Volume adjusted correctly"], ["MERCH", "TVs turned on/same content"], ["MERCH", "TV out of ECO mode"],
            ["HOUSE", "Shelves free of dust"], ["HOUSE", "TV stands free of dust"], ["HOUSE", "Cables neat and tidy"], ["HOUSE", "Box stock lined up"], ["HOUSE", "Floor cleaned/vacuumed"]
        ]},
        { id: 2, title: "Whites Audit", rows: [
            ["FREE", "Price ticket cut/pos ok"], ["FREE", "Energy Label Correct Size"], ["FREE", "Stickers removed"], ["FREE", "Price/Size logic"], ["FREE", "Info in grey bags"],
            ["INT", "Ticket laminated DL size"], ["INT", "Cooling: label inside door"], ["INT", "Cooking: label inside oven"], ["INT", "Hobs: top right corner"], ["INT", "Washers: label inside door"], ["INT", "Energy label laminated"], ["INT", "Promo position correct"],
            ["HOUSE", "Product fully cleaned"], ["HOUSE", "Barcodes hidden"], ["HOUSE", "Floor cleaned/vacuumed"]
        ]},
        { id: 3, title: "Digi Audit", rows: [
            ["PRICE", "Ticket in holder right"], ["PRICE", "Ticket cut straight"], ["PRICE", "Ticket correct position"],
            ["MERCH", "Promo in ticket holder"], ["MERCH", "Supplier stickers removed"], ["MERCH", "Essentials in place/priced"], ["MERCH", "Digi tables neat/tidy"], ["MERCH", "Bags out of plastic wraps"], ["MERCH", "Product in price/size logic"], ["MERCH", "Laptops on/screensaver"], ["MERCH", "Monitors playing demo"], ["MERCH", "Sleep mode turned off"],
            ["HOUSE", "Product cleaned"], ["HOUSE", "Shelves free of dust"], ["HOUSE", "Barcodes hidden"], ["HOUSE", "Floor cleaned/vacuumed"]
        ]},
        { id: 4, title: "General / BOH Audit", rows: [
            ["GEN", "Floor clear of dirt"], ["GEN", "Carpet vacuumed"], ["GEN", "Windows cleaned in/out"], ["GEN", "Front entrance cleaned"], ["GEN", "Entrance mat hoovered"], ["GEN", "Bins emptied"], ["GEN", "Cash desk clean/tidy"],
            ["BOH", "Canteen clean & tidy"], ["BOH", "Toilets clean & tidy"], ["BOH", "Loading area clean/tidy"], ["BOH", "Customer collections current"], ["BOH", "Open stock bubblewrapped"], ["BOH", "Repair section tidy/current"]
        ]}
    ];

    const DATA_MTY = [
        { id: 0, title: "Smalls Guideline", rows: [
            ["PRICE", "Ticketing Standards (Cut straight, Position correct, Holders intact)"], 
            ["PRICE", "Pricing Accuracy (Gun labels correct, Edge labels present)"], 
            ["PRICE", "No Missing Prices (All products priced)"],
            ["MERCH", "Floor Stacks (Microwaves/Fans/Airfryers) - Stocked, Safe & Priced"],
            ["MERCH", "Stock Availability (No Gaps, Pulled to front)"],
            ["MERCH", "End Caps & Display Logic (Dual displayed if applicable)"],
            ["HOUSE", "Product & Shelves Clean (No Dust, Gum, or Debris)"],
            ["HOUSE", "Floor Standards (Vacuumed & Clear of hazards)"]
        ]},
        { id: 1, title: "TV & Audio Audit", rows: [
            ["PRICE", "Ticketing Standards (Cut straight, Position correct, Holders intact)"],
            ["PRICE", "All TVs & Audio Units Priced (No missing tickets)"],
            ["PRICE", "Energy Label Compliance (Correct Position & Size)"],
            ["MERCH", "TV Stacks Full & Size Logic Correct"],
            ["MERCH", "Demo Ready (On, Same Content, Volume leveled, Non-Eco)"],
            ["MERCH", "Merchandising Standard (Stickers removed, Logic correct)"],
            ["HOUSE", "Dust Free (Screens, Stands, Shelves)"],
            ["HOUSE", "Cable Management (Neat, Tidy, Tied back)"]
        ]},
        { id: 2, title: "Whites Audit", rows: [
            ["PRICE", "Ticketing Standards (Cut straight, Position correct, Laminated)"],
            ["PRICE", "No Missing Prices (All Units on floor priced)"],
            ["PRICE", "Energy Label Compliance (Inside door or Oven)"],
            ["MERCH", "Manuals & Extras in Grey Bags"],
            ["MERCH", "Unit Presentation (Stickers removed, Gaps filled)"],
            ["HOUSE", "Hobs & Hoods Cleaned (Glass wiped, Buttons clean)"],
            ["HOUSE", "Freestanding Cookers Cleaned (Inside & Out)"],
            ["HOUSE", "Laundry Cleaned (No Gummy Marks, Doors wiped)"],
            ["HOUSE", "Refrigeration Cleaned (Doors & Handles wiped)"],
            ["HOUSE", "Built-in Ovens Cleaned (Glass polished, Fronts clean)"]
        ]},
        { id: 3, title: "Digi Audit", rows: [
            ["PRICE", "Ticketing Standards (Cut straight, Position correct)"],
            ["PRICE", "No Missing Prices (Laptops, Tablets, Monitors)"],
            ["MERCH", "Demo Ready (Laptops ON, Screensavers, No Sleep Mode)"],
            ["MERCH", "Accessories Standard (Priced, Gun full, Faced off)"],
            ["MERCH", "Stock Presentation (Bags unwrapped, Logic correct)"],
            ["HOUSE", "Hygiene (Screens fingerprint-free, Keys dusted)"]
        ]},
        { id: 4, title: "General / BOH Audit", rows: [
            ["MERCH", "Front Bays (Tills): Fully Stocked, Faced off & Priced"],
            ["MERCH", "Baskets: Full of stock, Faced off & Correct Price"],
            ["GEN", "Sales Counter: No Stock, No Rubbish, No Personal Items"],
            ["GEN", "Entrance & Walkways (Mat hoovered, Windows clean)"],
            ["HOUSE", "All Shop Floor Bins Emptied"],
            ["HOUSE", "Bays: Clean & No Dirt (Especially Bottom Shelves)"],
            ["BOH", "Canteen: Clean, Tidy & Bins Emptied"],
            ["BOH", "Toilets: Male Clean, Stocked & Bins Emptied"],
            ["BOH", "Toilets: Female Clean, Stocked & Bins Emptied"],
            ["BOH", "Loading Bay / Goods In (Tidy, Clear)"],
            ["BOH", "Stock Room / Whse (Organized, Open stock wrapped)"],
            ["BOH", "Customer Orders (Collections & Repairs Tidy)"]
        ]}
    ];

    // ==========================================
    // 2. STATE & INIT LOGIC
    // ==========================================

    let currentSection = 0;
    let sections = []; // Will be loaded with DID or MTY
    let appMode = ''; // 'did' or 'mty'
    let totalSections = 0;
    let auditData = { ticks: {}, notes: {}, mainNotes: {}, photos: [[],[],[],[],[]] };

    function selectMode(mode) {
        appMode = mode;
        if (mode === 'did') {
            sections = DATA_DID;
            document.getElementById('pageTitle').innerText = "DID STANDARD";
        } else {
            sections = DATA_MTY;
            document.getElementById('pageTitle').innerText = "MTY CORE COMPLIANCE";
        }
        totalSections = sections.length;
        
        // Hide Launcher, Show App
        document.getElementById('launcher').style.display = 'none';
        document.getElementById('main-app-wrapper').style.display = 'block';
        
        // Render UI Structure
        renderUI();
        
        // Boot App logic
        initApp();
    }

    function renderUI() {
        let html = '';
        sections.forEach((sec, idx) => {
            html += `
            <div class="audit-section ${idx===0?'active':''}" id="section-${sec.id}">
                <div class="sheet">
                    <div class="header-row"><h1>${sec.title}</h1><div class="date-time dt-target"></div></div>
                    <table>
                        <thead><tr><th class="col-cat">CAT</th><th class="col-item">CHECKPOINT</th><th class="col-check">Y</th><th class="col-check">N</th><th class="col-action">NOTES</th></tr></thead>
                        <tbody>`;
            sec.rows.forEach((row, rIdx) => {
                html += `
                    <tr>
                        <td class="col-cat">${row[0]}</td>
                        <td class="col-item">${row[1]}</td>
                        <td class="col-check" onclick="pick(this, true)"><div class="choice yes"></div></td>
                        <td class="col-check" onclick="pick(this, false)"><div class="choice no"></div></td>
                        <td class="col-action">
                            <textarea oninput="mirrorText(this)"></textarea>
                            <div class="pdf-text-mirror"></div>
                        </td>
                    </tr>`;
            });
            html += `
                        </tbody>
                    </table>
                    <div class="notes-container">
                        <strong>NOTES:</strong>
                        <div class="notes-box-wrapper" style="position:relative;">
                            <textarea class="notes-box" oninput="mirrorText(this)"></textarea>
                            <div class="pdf-text-mirror notes-box" style="border:none; padding:0;"></div>
                        </div>
                    </div>
                    <div class="signatures">
                        <div class="sig-block"><div class="sig-line"></div><div class="sig-text">Staff Sign</div><div class="sig-line" style="margin-top:10px"></div><div class="sig-text">Cluster Mgr</div></div>
                        <div class="sig-block"><div class="sig-line"></div><div class="sig-text">Duty Mgr</div><div class="sig-line" style="margin-top:10px"></div><div class="sig-text">Date</div></div>
                    </div>
                </div>
                <div class="sheet photo-sheet" id="grid-${sec.id}"><div class="header-row"><h1>${sec.title} Photos</h1><div class="date-time dt-target"></div></div><div class="photo-grid"></div></div>
            </div>`;
        });
        document.getElementById('app-container').innerHTML = html;
    }

    async function initApp() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        // Unique store per mode prevents data mixing
        localforage.config({ name: 'AuditApp', storeName: appMode });
        
        const savedPos = localStorage.getItem('audit_idx_' + appMode);
        if(savedPos) currentSection = parseInt(savedPos);
        
        const val = await localforage.getItem('auditData');
        if(val) auditData = val;
        else auditData = { ticks: {}, notes: {}, mainNotes: {}, photos: [[],[],[],[],[]] }; // Reset if new

        applyDataToDOM();
        showSection(currentSection);
        updateTime();
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    // ==========================================
    // 3. CORE LOGIC
    // ==========================================

    function mirrorText(el) {
        const mirror = el.parentElement.querySelector('.pdf-text-mirror');
        if(mirror) {
            mirror.innerHTML = el.value.replace(/\n/g, '<br>');
        }
    }

    function showSection(idx) {
        if (idx < 0) idx = 0; if (idx >= totalSections) idx = totalSections - 1;
        currentSection = idx;
        localStorage.setItem('audit_idx_' + appMode, idx);
        document.querySelectorAll('.audit-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`section-${idx}`).classList.add('active');
        const pb = document.querySelector('.btn-prev');
        const nb = document.querySelector('.btn-next');
        const sb = document.querySelector('.btn-submit');
        pb.style.visibility = (currentSection === 0) ? 'hidden' : 'visible';
        if (currentSection === totalSections - 1) { nb.style.display = 'none'; sb.style.display = 'block'; }
        else { nb.style.display = 'block'; sb.style.display = 'none'; }
        window.scrollTo(0,0);
    }

    function changeSection(dir) { showSection(currentSection + dir); }

    function updateTime() {
        const str = new Date().toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' });
        document.querySelectorAll('.dt-target').forEach(el => el.innerText = str);
    }

    async function saveState() { await localforage.setItem('auditData', auditData); }

    function pick(el, isYes) {
        const row = el.closest("tr");
        const secIdx = Array.from(document.querySelectorAll('.audit-section')).indexOf(row.closest('.audit-section'));
        const rowIdx = Array.from(row.parentElement.children).indexOf(row);
        row.querySelectorAll(".choice").forEach(c => c.classList.remove("active"));
        el.querySelector(".choice").classList.add("active");
        auditData.ticks[`${secIdx}-${rowIdx}`] = isYes ? 'yes' : 'no';
        saveState();
        if (!isYes) {
            activeRowInfo = { secIdx, rowIdx };
            document.getElementById('cameraInput').click();
        }
    }

    document.addEventListener('input', (e) => {
        if(e.target.tagName === 'TEXTAREA') {
            const sec = e.target.closest('.audit-section');
            const secIdx = Array.from(document.querySelectorAll('.audit-section')).indexOf(sec);
            if(e.target.classList.contains('notes-box')) auditData.mainNotes[secIdx] = e.target.value;
            else {
                const row = e.target.closest('tr');
                const rowIdx = Array.from(row.parentElement.children).indexOf(row);
                auditData.notes[`${secIdx}-${rowIdx}`] = e.target.value;
            }
            saveState();
        }
    });

    let activeRowInfo = null;
    
    // FIX: Optimized Memory Handling for Camera Input
    document.getElementById('cameraInput').addEventListener('change', function(e) {
        const file = this.files[0];
        if (!file || !activeRowInfo) return;

        // Use URL.createObjectURL to avoid loading massive Base64 string into memory
        const imgUrl = URL.createObjectURL(file);
        const img = new Image();
        img.src = imgUrl;

        img.onload = function() {
            const canvas = document.createElement('canvas');
            // Safe Resolution Limit (700px width is enough for PDF)
            const maxWidth = 700; 
            let w = img.width, h = img.height;
            if(w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
            
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);

            // Compress to 0.4 quality (approx 50-80kb file)
            const dataUrl = canvas.toDataURL('image/jpeg', 0.4);

            // CLEANUP: Immediately free memory
            URL.revokeObjectURL(imgUrl);

            const { secIdx, rowIdx } = activeRowInfo;
            const row = document.querySelectorAll('.audit-section')[secIdx].querySelectorAll('tbody tr')[rowIdx];
            
            if (!auditData.photos[secIdx]) auditData.photos[secIdx] = [];
            
            const count = auditData.photos[secIdx].length + 1;
            const txtField = row.querySelector('textarea');
            txtField.value = `[Photo ${count}]\n` + txtField.value;
            mirrorText(txtField);
            auditData.notes[`${secIdx}-${rowIdx}`] = txtField.value;
            auditData.photos[secIdx].push({ src: dataUrl, label: `Photo ${count}: ${row.cells[1].innerText}` });
            
            saveState().then(() => { renderPhotos(secIdx); });
        };
        
        // Handle loading errors
        img.onerror = function() {
            URL.revokeObjectURL(imgUrl);
            alert("Error loading image. Please try again.");
        };
    });

    function renderPhotos(secIdx) {
        const grid = document.getElementById(`grid-${secIdx}`).querySelector('.photo-grid');
        grid.innerHTML = '';
        if(auditData.photos[secIdx]) {
            auditData.photos[secIdx].forEach(p => {
                grid.innerHTML += `<div class="photo-card"><img src="${p.src}"><div class="photo-label">${p.label}</div></div>`;
            });
        }
    }

    function applyDataToDOM() {
        document.querySelectorAll('.audit-section').forEach((sec, secIdx) => {
            sec.querySelectorAll('tbody tr').forEach((row, rowIdx) => {
                const tick = auditData.ticks[`${secIdx}-${rowIdx}`];
                if (tick) row.querySelector('.choice.' + tick).classList.add('active');
                if (auditData.notes[`${secIdx}-${rowIdx}`]) {
                    const txt = row.querySelector('textarea');
                    txt.value = auditData.notes[`${secIdx}-${rowIdx}`];
                    mirrorText(txt);
                }
            });
            if (auditData.mainNotes[secIdx]) {
                const txt = sec.querySelector('.notes-box');
                txt.value = auditData.mainNotes[secIdx];
                mirrorText(txt);
            }
            renderPhotos(secIdx);
        });
    }

    function resetForm() { 
        if(confirm("Delete all data for this audit mode?")) { 
            localforage.clear().then(() => { 
                localStorage.removeItem('audit_idx_' + appMode); 
                location.reload(); 
            }); 
        } 
    }

    async function handleEmailAction() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadingText').innerText = "GENERATING PDF...";
        const container = document.getElementById('app-container');
        container.classList.add('pdf-mode');
        
        document.querySelectorAll('.photo-sheet').forEach((sheet, idx) => {
            const grid = sheet.querySelector('.photo-grid');
            const count = (auditData.photos[idx] || []).length;
            if (count === 0) {
                sheet.style.display = 'none';
            } else {
                sheet.style.display = 'flex';
                if(count === 1) grid.classList.add('p-1');
                else if(count === 2) grid.classList.add('p-2');
            }
        });

        const dateStr = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
        const filename = `${appMode === 'did' ? 'DID_Standard' : 'MTY_Core_Compliance'} Check ${dateStr}.pdf`;

        const opt = {
            margin: 0,
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 1.8, scrollY: 0, useCORS: true, windowWidth: 794 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        try {
            const pdfBlob = await html2pdf().set(opt).from(container).output('blob');
            
            container.classList.remove('pdf-mode');
            document.querySelectorAll('.photo-sheet').forEach((sheet) => {
                sheet.style.display = 'flex';
                const grid = sheet.querySelector('.photo-grid');
                grid.classList.remove('p-1', 'p-2');
            });
            showSection(currentSection);
            document.getElementById('loadingOverlay').style.display = 'none';

            const file = new File([pdfBlob], filename, { type: 'application/pdf' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Audit Report',
                        text: `Attached is the audit report for ${dateStr}`
                    });
                } catch (shareError) {
                    console.log('Share failed/cancelled, downloading instead');
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
                }
            } else {
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
            }

        } catch (e) { 
            alert("Error: " + e.message); 
            container.classList.remove('pdf-mode'); 
            document.getElementById('loadingOverlay').style.display = 'none'; 
        }
    }
</script>
</body>
</html>
